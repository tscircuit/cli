name: Bun Test

on:
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    if: "${{ github.event_name != 'pull_request' || github.event.pull_request.title != 'chore: bump version' }}"
    timeout-minutes: 15
    strategy:
      matrix:
        node: [1, 2, 3, 4, 5]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Install dependencies
        run: bun install
      
      - run: bunx playwright install
      - run: npm ls zod
      
      - run: |
          set -euo pipefail

          echo "=== Basic env ==="
          echo "pwd: $(pwd)"
          echo "CI: ${CI:-}"
          echo "NODE_ENV: ${NODE_ENV:-}"
          bun --version
          node -v || true
          uname -a || true

          echo
          echo "=== Install tools ==="
          sudo apt-get update -y
          sudo apt-get install -y ripgrep

          echo
          echo "=== Lockfiles present ==="
          ls -la bun.lock bun.lockb 2>/dev/null || true

          echo
          echo "=== bun install (FROZEN, fail if lockfile would change) ==="
          bun install --frozen-lockfile

          echo
          echo "=== bun dep tree (key packages) ==="
          bun pm ls zod || true
          bun pm ls @tscircuit/props tscircuit easyeda @tscircuit/core || true

          echo
          echo "=== Resolution & runtime sanity (zod) ==="
          bun - <<'BUN'
          const zod = await import("zod");
          const pkg = await import("zod/package.json");
          console.log("import.meta.resolve('zod') =", import.meta.resolve("zod"));
          console.log("zod version =", (pkg.default ?? pkg).version);

          const z = zod.z;
          console.log("has z:", !!z);
          console.log("typeof z.string:", typeof z?.string);
          if (z && typeof z.string === "function") {
          const s = z.string();
          console.log("typeof z.string()._parse:", typeof s._parse);
          }
          BUN

          echo
          echo "=== Inspect @tscircuit/props compiled entrypoints ==="
          node -e "console.log(require('@tscircuit/props/package.json'))" || true

          for f in \
          node_modules/@tscircuit/props/dist/index.js \
          node_modules/@tscircuit/props/dist/*.js \
          node_modules/@tscircuit/props/dist/**/*.js; do
          if [ -f "$f" ]; then
          echo "--- $f (first 80 lines) ---"
          sed -n '1,80p' "$f" || true
          break
          fi
          done

          echo
          echo "=== Search node_modules for record(keySchema) mistakes and zod import quirks ==="
          # catches minified and unminified
          rg "z\.record\(\s*z\.string\b|z\.record\(z\.string\b|z\.record\(\s*z\.number\b|z\.record\(z\.number\b" node_modules -n || true
          rg "keyValidator\._parse|_parse\(new ParseInputLazyPath|ParseInputLazyPath" node_modules -n || true
          rg 'import\s+z\s+from\s+"zod"|require\("zod"\)\.default|from\s+"zod"' node_modules -n || true

          echo
          echo "=== Done ==="

      - name: Generate test plans
        run: bun run scripts/generate-test-plan.ts

      - name: Run tests for node ${{ matrix.node }}
        run: |
          if [ ! -f ".github/test-plans/node${{ matrix.node }}-testplan.txt" ]; then
            echo "ERROR: No test plan found for node ${{ matrix.node }}"
            exit 1
          fi

          mapfile -t test_files < .github/test-plans/node${{ matrix.node }}-testplan.txt
          if [ ${#test_files[@]} -eq 0 ]; then
            echo "ERROR: No test files in plan for node ${{ matrix.node }}"
            exit 1
          fi

          echo "Running ${#test_files[@]} test files for node ${{ matrix.node }}"
          attempt=1
          while [ $attempt -le 4 ]; do
            bun test ${test_files[@]} --timeout 20000
            code=$?

            if [ $code -eq 0 ]; then
              break
            fi

            if [ $code -ne 139 ] && [ $code -ne 132 ]; then
              exit $code
            fi

            if [ $attempt -eq 4 ]; then
              echo "Segmentation fault or illegal instruction detected after $attempt attempts (exit=$code)."
              exit $code
            fi

            attempt=$((attempt + 1))
            echo "Segfault (139) or illegal instruction (132) detected, retrying ($attempt/4)..."
          done

      - name: Upload Snapshot Artifacts on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: snapshots-node${{ matrix.node }}
          path: |
            tests/**/__snapshots__/*.diff.png
            tests/**/__snapshots__/*.snap.png
          if-no-files-found: ignore
